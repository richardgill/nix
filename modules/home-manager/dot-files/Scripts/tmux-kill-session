#!/usr/bin/env bash

LOG_FILE="$HOME/Library/Logs/tmux-scripts/tmux-kill-session.log"
mkdir -p "$(dirname "$LOG_FILE")"

log() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

assume_yes=0
session=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --yes) assume_yes=1; shift;;
    --) shift; break;;
    *) session="${session:-$1}"; shift;;
  esac
done

# If no session provided, get current session
if [[ -z "$session" ]]; then
  session=$(tmux display-message -p '#S' 2>/dev/null || echo "")
fi
[[ -n "$session" ]] || { echo "No tmux session specified or active."; exit 1; }

log "Starting kill session for: $session (assume_yes=$assume_yes)"

# Ask for confirmation unless --yes was set
if (( ! assume_yes )); then
  read -r -p "Confirm kill tmux session '$session'? [y/N] " resp
  if [[ ! "$resp" =~ ^([yY]|[yY][eE][sS])$ ]]; then
    echo "Aborted session termination."
    log "User aborted session termination for: $session"
    exit 0
  fi
fi

# Self-protect if running inside the target session
current_session="$(tmux display-message -p '#S' 2>/dev/null || true)"
in_target_session=0
[[ -n "$current_session" && "$current_session" == "$session" ]] && in_target_session=1
self_tty="$(tty 2>/dev/null || true)"
trap '' HUP

# Get all pane IDs in the session
panes=()
while IFS= read -r pane_id; do
  [[ -n "$pane_id" ]] && panes+=("$pane_id")
done < <(tmux list-panes -t "$session:" -s -F '#{session_name}:#{window_index}.#{pane_index}' 2>/dev/null || true)

if (( ${#panes[@]} == 0 )); then
  log "No panes found for session '$session'"
else
  log "Found ${#panes[@]} panes for session '$session': ${panes[*]}"

  # Kill each pane in parallel (tmux-kill-pane handles self-protection)
  for pane in "${panes[@]}"; do
    # Skip our own pane if we're in the target session (let kill-session handle it)
    if (( in_target_session )); then
      pane_tty=$(tmux display-message -t "$pane" -p '#{pane_tty}' 2>/dev/null || true)
      [[ "$pane_tty" == "$self_tty" ]] && { log "Skipping own pane: $pane"; continue; }
    fi
    "$SCRIPT_DIR/tmux-kill-pane" "$pane" &
  done

  # Wait for all background kill-pane processes
  wait
  log "All pane kills completed"
fi

# Kill the session
if tmux kill-session -t "$session" 2>&1 | tee -a "$LOG_FILE"; then
  log "Successfully killed session: $session"
else
  log "Failed to kill session: $session"
fi
