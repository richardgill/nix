#!/usr/bin/env bash
# Eternal Terminal with automatic reverse tunnel setup
# Usage: ssh-with-tunnel <remote-host> [remote-user]
#        ssht <remote-host> [remote-user]  (alias)
#
# Establishes a reverse SSH tunnel in background, then connects with ET.
# On the remote, you can use 'tunnel-open' and 'beep' to interact with your local machine.

HOST="${1:?Usage: ssh-with-tunnel <remote-host> [remote-user]}"
USER="${2:-$USER}"

tunnel-setup "$@"

# Connect with Eternal Terminal (handles reconnection automatically)
# Fall back to SSH if ET not available
if command -v et &>/dev/null; then
  et "$USER@$HOST"
else
  if command -v caffeinate &>/dev/null; then
    caffeinate -i ssh "$USER@$HOST"
  else
    ssh "$USER@$HOST"
  fi
fi
