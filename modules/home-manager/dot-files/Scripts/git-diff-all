#!/usr/bin/env bash

set -euo pipefail

cleanup() {
  if [ ${#untracked_files[@]} -gt 0 ]; then
    echo -e "\nðŸ§¹ Cleaning up intent-to-add..." >&2
    echo "Running: git reset -- ${untracked_files[*]}" >&2
    git reset -- "${untracked_files[@]}" 2>/dev/null || true
  fi
}

trap cleanup EXIT INT TERM

untracked_files=()
while IFS= read -r file; do
  untracked_files+=("$file")
done < <(git ls-files --others --exclude-standard)

if [ ${#untracked_files[@]} -eq 0 ]; then
  echo "No untracked files found. Running regular diff..." >&2
  exec git diff HEAD "$@"
fi

echo "ðŸ“ Adding intent for ${#untracked_files[@]} untracked file(s)..." >&2
git add -N -- "${untracked_files[@]}"

echo "ðŸ“Š Showing diff (including untracked files)..." >&2
echo "" >&2

git diff HEAD "$@"
