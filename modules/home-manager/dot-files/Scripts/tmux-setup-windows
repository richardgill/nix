#!/usr/bin/env bash

create_worktree_session() {
  local expanded_path="$1"
  local detached="$2"
  local session_name="$(basename "$(dirname "$expanded_path")")/$(basename "$expanded_path")"
  tmux new-session -d -s "$session_name" -c "$expanded_path"
  [[ -z "$detached" ]] && tmux switch-client -t "$session_name"
  echo "$session_name"
}

create_repo_session() {
  local expanded_path="$1"
  local session_name="$(basename "$expanded_path")"
  tmux new-session -d -s "$session_name" -c "$expanded_path"
  tmux switch-client -t "$session_name"
  echo "$session_name"
}

create_session_for_path() {
  local expanded_path="$1"
  zoxide add "$expanded_path"
  if [ -d "$(realpath "$expanded_path/../main" 2>/dev/null)" ]; then
    create_worktree_session "$expanded_path"
  else
    create_repo_session "$expanded_path"
  fi
}

setup_tmux_windows() {
  local session_name="$1"
  local ai1_cmd="$2"
  if [ -z "$session_name" ] && [ -n "$TMUX" ]; then
    session_name=$(tmux display-message -p "#{session_name}")
  fi

  if [ -n "$session_name" ]; then
    ORIGINAL_WINDOW=$(tmux display-message -t "$session_name" -p "#{window_id}")
    ORIGINAL_PANE=$(tmux display-message -t "$session_name" -p "#{pane_id}")
    ORIGINAL_PATH=$(tmux display-message -t "$session_name" -p "#{pane_current_path}")

    tmux rename-window -t "$ORIGINAL_WINDOW" "nvim"

    SOCKET_FILE="/tmp/nvim-socket-$(uuidgen)"
    tmux send-keys -t "$ORIGINAL_PANE" "v . --listen $SOCKET_FILE" Enter

    tmux new-window -t "$session_name" -a -c "$ORIGINAL_PATH" -n "short"
    tmux new-window -t "$session_name" -a -c "$ORIGINAL_PATH" -n "long"

    # Stagger Claude Code launches - concurrent starts cause issues
    AI_WINDOW_1=$(tmux new-window -t "$session_name" -a -c "$ORIGINAL_PATH" -n "ai1" -P -F "#{window_id}")
    tmux send-keys -t "$AI_WINDOW_1" "${ai1_cmd:-cl}" Enter

    AI_WINDOW_2=$(tmux new-window -t "$session_name" -a -c "$ORIGINAL_PATH" -n "ai2" -P -F "#{window_id}")
    (sleep 2 && tmux send-keys -t "$AI_WINDOW_2" "cl" Enter) &

    AI_WINDOW_3=$(tmux new-window -t "$session_name" -a -c "$ORIGINAL_PATH" -n "ai3" -P -F "#{window_id}")
    (sleep 4 && tmux send-keys -t "$AI_WINDOW_3" "cl" Enter) &

    tmux select-window -t "$AI_WINDOW_1"

    echo "$SOCKET_FILE"
  fi
}
