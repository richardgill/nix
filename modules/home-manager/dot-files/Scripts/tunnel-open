#!/usr/bin/env bash
# Smart URL/file opener that works both locally and over SSH
# Source: https://github.com/suan/local-open
# Usage: tunnel-open <url|file>
#
# If running locally: uses xdg-open or open
# If in SSH session: opens on local machine via reverse tunnel
# Automatically converts localhost/127.0.0.1/0.0.0.0 to remote hostname
#
# Configuration (environment variables):
#   TUNNEL_CMD - Command to open files (default: "open")
#   TUNNEL_ALT_HOST - Hostname to replace localhost with (default: `hostname`)
#
# Setup: Start a tunnel with tunnel-setup or ssh-with-tunnel
# Remember: the local machine also needs SSH server enabled

source ~/Scripts/lib/ssh

alt_localhost=${TUNNEL_ALT_HOST-`hostname`}
url=$1
open_cmd=${TUNNEL_CMD-"open"}

if ! is_ssh_session; then
  if hash xdg-open 2>/dev/null; then
    open_cmd=`which xdg-open`
  else
    open_cmd=`which open`
  fi
  # xdg-open was printing weird output, supress it
  $open_cmd "$url" &>/dev/null
else
  if [[ "$url" == *localhost* ]]; then
    url=${url/localhost/$alt_localhost}
  elif [[ "$url" == *"127.0.0.1"* ]]; then
    url=${url/127\.0\.0\.1/$alt_localhost}
  elif [[ "$url" == *"0.0.0.0"* ]]; then
    url=${url/0\.0\.0\.0/$alt_localhost}
  fi
  tunnel-exec "$open_cmd \"$url\""
fi
