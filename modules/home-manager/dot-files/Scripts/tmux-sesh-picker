#!/usr/bin/env bash
# Sesh picker for use from within other fzf popups (via become)

HOME_DIR="$HOME"

selected=$(sesh list --icons | fzf --ansi \
  --no-sort --border-label ' sesh ' --prompt 'โก  ' \
  --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find | F12/ยง prefix' \
  --bind 'tab:down,btab:up' \
  --bind 'ctrl-a:change-prompt(โก  )+reload(sesh list --icons)' \
  --bind 'ctrl-t:change-prompt(๐ช  )+reload(sesh list -t --icons)' \
  --bind 'ctrl-g:change-prompt(โ๏ธ  )+reload(sesh list -c --icons)' \
  --bind 'ctrl-x:change-prompt(๐  )+reload(sesh list -z --icons)' \
  --bind "ctrl-f:change-prompt(๐  )+reload($HOME_DIR/Scripts/find-dirs)" \
  --bind "ctrl-d:execute($HOME_DIR/Scripts/tmux-kill-session --yes {2..})+change-prompt(โก  )+reload(sesh list --icons)" \
  --bind "w:become($HOME_DIR/Scripts/claude-sessions)" \
  --bind 'a:abort+execute-silent(tmux select-window -t :1)' \
  --bind 'r:abort+execute-silent(tmux select-window -t :2)' \
  --bind 's:abort+execute-silent(tmux select-window -t :3)' \
  --bind 't:abort+execute-silent(tmux select-window -t :4)' \
  --bind 'g:abort+execute-silent(tmux select-window -t :5)' \
  --bind 'm:abort+execute-silent(tmux select-window -t :6)' \
  --bind 'start:unbind(w,a,r,s,t,g,m)' \
  --bind 'f12:transform:[[ "$FZF_PROMPT" == "ยง "* ]] && echo "change-prompt(โก  )+unbind(w,a,r,s,t,g,m)" || echo "change-prompt(ยง )+rebind(w,a,r,s,t,g,m)"' \
  --bind 'ยง:transform:[[ "$FZF_PROMPT" == "ยง "* ]] && echo "change-prompt(โก  )+unbind(w,a,r,s,t,g,m)" || echo "change-prompt(ยง )+rebind(w,a,r,s,t,g,m)"' \
  --preview-window 'right:55%,<65(down,75%)' \
  --layout=reverse \
  --preview 'sesh preview {}')

[[ -n "$selected" ]] && "$HOME_DIR/Scripts/tmux-session-connect" "$selected"
