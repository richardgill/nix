#!/usr/bin/env bash
# Sesh picker for use from within other fzf popups (via become)

HOME_DIR="$HOME"
SESH_LIST="sesh list --icons"
MODE_SESH="sesh"
MODE_DIRS="all dirs"
HEADER_BASE='  mode: %s | ^a toggle %s | ^q kill | F12/ยง prefix'
HEADER_SESH=$(printf "$HEADER_BASE" "$MODE_SESH" "$MODE_DIRS")
HEADER_DIRS=$(printf "$HEADER_BASE" "$MODE_DIRS" "$MODE_SESH")
MODE_FILE=$(mktemp)
PREFIX_FILE=$(mktemp)
printf '%s' "$MODE_SESH" > "$MODE_FILE"
rm -f "$PREFIX_FILE"
trap 'rm -f "$MODE_FILE" "$PREFIX_FILE"' EXIT

selected=$(eval "$SESH_LIST" | fzf --ansi \
  --no-sort --border-label ' sesh ' --prompt '' \
  --header "$HEADER_SESH" \
  --bind 'tab:down,btab:up' \
  --bind "ctrl-a:transform:[[ \"\$(cat \"$MODE_FILE\")\" == \"$MODE_DIRS\" ]] && echo \"execute-silent(printf '%s' '$MODE_SESH' > '$MODE_FILE')+change-header($HEADER_SESH)+reload($SESH_LIST)\" || echo \"execute-silent(printf '%s' '$MODE_DIRS' > '$MODE_FILE')+change-header($HEADER_DIRS)+reload($HOME_DIR/Scripts/find-dirs)\"" \
  --bind "ctrl-q:execute($HOME_DIR/Scripts/tmux-kill-session --yes {2..})+execute-silent(printf '%s' '$MODE_SESH' > '$MODE_FILE')+change-header($HEADER_SESH)+reload($SESH_LIST)" \
  --bind "w:become($HOME_DIR/Scripts/claude-sessions)" \
  --bind 'a:abort+execute-silent(tmux select-window -t :1)' \
  --bind 'r:abort+execute-silent(tmux select-window -t :2)' \
  --bind 's:abort+execute-silent(tmux select-window -t :3)' \
  --bind 't:abort+execute-silent(tmux select-window -t :4)' \
  --bind 'g:abort+execute-silent(tmux select-window -t :5)' \
  --bind 'b:abort+execute-silent(tmux select-window -t :6)' \
  --bind 'start:unbind(w,a,r,s,t,g,b)' \
  --bind "f12:transform:[[ -f \"$PREFIX_FILE\" ]] && echo \"execute-silent(rm -f '$PREFIX_FILE')+unbind(w,a,r,s,t,g,b)\" || echo \"execute-silent(touch '$PREFIX_FILE')+rebind(w,a,r,s,t,g,b)\"" \
  --bind "ยง:transform:[[ -f \"$PREFIX_FILE\" ]] && echo \"execute-silent(rm -f '$PREFIX_FILE')+unbind(w,a,r,s,t,g,b)\" || echo \"execute-silent(touch '$PREFIX_FILE')+rebind(w,a,r,s,t,g,b)\"" \
  --preview-window 'right:55%,<65(down,75%)' \
  --layout=reverse \
  --preview 'sesh preview {}')

[[ -n "$selected" ]] && "$HOME_DIR/Scripts/tmux-session-connect" "$selected"
