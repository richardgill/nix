#!/usr/bin/env bash
# @describe Create git worktree with tmux session
# @option -c --cmd Command to run in ai1 window instead of default 'cl' (e.g. wtb -c 'claude "fix bug"' my-branch)
# @flag -d --detached Don't switch to the new tmux session
# @flag -p --pull Automatically pull main if behind (no prompt)
# @arg source_branch! Branch name or remote/branch (e.g., origin/my-branch)
# @arg dest_name Destination name (defaults to source_branch name)

eval "$(argc --argc-eval "$0" "$@")"

source "$(dirname "$0")/tmux-setup-windows"
source ~/Scripts/lib/git

if [[ ! -d .git || "$(basename "$(pwd)")" != "main" ]]; then
  echo "Error: must be run from the main worktree directory named 'main'" >&2
  exit 1
fi

# Check if main is behind origin/upstream and offer to pull
if [[ "$(git symbolic-ref --short HEAD 2>/dev/null)" == "main" ]]; then
  remote=$(get_default_remote "main")
  git fetch "$remote" main --quiet 2>/dev/null
  behind=$(git rev-list --count HEAD.."$remote/main" 2>/dev/null || echo 0)
  if [[ "$behind" -gt 0 ]]; then
    if [[ -n "$argc_pull" ]]; then
      git pull "$remote" main
    else
      printf "main is %d commit(s) behind %s/main. Pull? (y/n) " "$behind" "$remote"
      read -r -n 1 REPLY
      echo
      [[ $REPLY =~ ^[Yy]$ ]] && git pull "$remote" main
    fi
  fi
fi

SOURCE=$(realpath .)
SOURCE_BRANCH="$argc_source_branch"
DEST_NAME="$argc_dest_name"

# Handle single argument that is a remote branch (e.g., origin/branch-name)
if [ -z "$DEST_NAME" ] && [[ "$SOURCE_BRANCH" == */* ]]; then
  # For single remote branch argument, extract branch name and use it as both directory and branch name
  DEST_NAME=$(echo "$SOURCE_BRANCH" | cut -d'/' -f2-)
fi

# If no destination name provided, use source branch name
if [ -z "$DEST_NAME" ]; then
  DEST_NAME="$SOURCE_BRANCH"
fi

TARGET="$SOURCE/../$DEST_NAME"

name_exists() {
  local name="$1"
  [ -d "$SOURCE/../$name" ] || git worktree list | grep -qE "\[$name\]$"
}

if name_exists "$DEST_NAME"; then
  echo "Error: '$DEST_NAME' already exists" >&2
  [ -d "$TARGET" ] && echo "  directory: $TARGET" >&2
  git worktree list | grep -E "\[$DEST_NAME\]$" | awk '{print "  worktree: " $1}' >&2
  n=1
  while name_exists "$DEST_NAME-$n"; do ((n++)); done
  echo "next available branch name: $DEST_NAME-$n" >&2
  exit 1
fi

# Determine if we have a source branch to create from
if [ -n "$argc_dest_name" ]; then
  if [[ "$SOURCE_BRANCH" == */* ]]; then
    REMOTE=$(echo "$SOURCE_BRANCH" | cut -d'/' -f1)
    BRANCH=$(echo "$SOURCE_BRANCH" | cut -d'/' -f2-)
    echo "Fetching remote branch $SOURCE_BRANCH..."
    git fetch "$REMOTE" "$BRANCH"
    git worktree add -b "$DEST_NAME" "$TARGET" "$SOURCE_BRANCH"
    # Push the new branch to create origin/$DEST_NAME and update tracking from origin/$BRANCH to origin/$DEST_NAME
    cd "$TARGET"
    git push -u origin "$DEST_NAME"
    cd -
  else
    git worktree add "$TARGET" "$SOURCE_BRANCH"
  fi
elif [[ "$SOURCE_BRANCH" == */* ]]; then
  REMOTE=$(echo "$SOURCE_BRANCH" | cut -d'/' -f1)
  BRANCH=$(echo "$SOURCE_BRANCH" | cut -d'/' -f2-)
  echo "Fetching remote branch $SOURCE_BRANCH..."
  git fetch "$REMOTE" "$BRANCH"
  git worktree add -b "$DEST_NAME" "$TARGET" "$SOURCE_BRANCH"
  # Push the new branch to create origin/$DEST_NAME and update tracking from origin/$BRANCH to origin/$DEST_NAME
  cd "$TARGET"
  git push -u origin "$DEST_NAME"
  cd -
else
  git worktree add "$TARGET"
fi

# Trust mise configs before tmux session starts (shell hook runs on cd to TARGET)
mise trust --all --cd "$TARGET"

TMUX_SESSION=$(create_worktree_session $(realpath "$TARGET") "$argc_detached")
SOCKET_FILE=$(setup_tmux_windows "$TMUX_SESSION" "$argc_cmd")

tmux send-keys -t "${TMUX_SESSION}:long" "$(dirname "$0")/worktree-branch-setup \"$SOURCE\" \"$TARGET\" \"$SOCKET_FILE\"" Enter
