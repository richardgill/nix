#!/usr/bin/env bash
# Claude Code launcher with session tracking and summary generation
#
# Hooks:
#   SessionStart - stores session ID in tmux pane for cc-test.sh
#   Stop - generates debounced summaries via claude-summary-hook

[[ -n "$TMUX_PANE" ]] && tmux rename-window -t "$TMUX_PANE" "cl"

# Patch dev-browser plugin to use system Chromium (idempotent, runs in background)
"$HOME/Scripts/patch-dev-browser" &>/dev/null &

# Isolate Claude's temp files to avoid ENXIO errors from socket files in /tmp
# The native binary's file watcher crashes when it encounters Unix sockets
# (nvim, vscode IPC, etc.) because fs.watch() can't watch socket files.
# https://github.com/anthropics/claude-code/issues/15112
export TMPDIR="${TMPDIR:-/tmp}/claude-tmp"
mkdir -p "$TMPDIR"

export DISABLE_AUTOUPDATER=1

session_start_hook='sid=$(cat | jq -r ".session_id // empty"); [[ -n "$TMUX_PANE" && -n "$sid" ]] && tmux set-option -t "$TMUX_PANE" -p @claude_session_id "$sid"'

settings=$(jq -nc \
  --arg start "$session_start_hook" \
  --arg stop "$HOME/Scripts/claude-summary-hook" \
  '{
    hooks: {
      SessionStart: [{
        hooks: [{type: "command", command: $start}]
      }],
      Stop: [{
        hooks: [{type: "command", command: $stop}]
      }]
    }
  }')

exec mise exec claude-code -- claude --settings "$settings" "$@"
